# API Design Reference

REST conventions, request/response contracts, and error handling patterns.

## REST Conventions

### Resource-Oriented Endpoints

**Standard CRUD operations:**
```
GET    /orders          # List orders
POST   /orders          # Create order
GET    /orders/:id      # Get single order
PATCH  /orders/:id      # Update order
DELETE /orders/:id      # Delete order
```

**Nested resources:**
```
GET    /orders/:orderId/items          # List order items
POST   /orders/:orderId/items          # Add item to order
GET    /orders/:orderId/items/:itemId  # Get order item
PATCH  /orders/:orderId/items/:itemId  # Update order item
DELETE /orders/:orderId/items/:itemId  # Delete order item
```

### Actions (Non-CRUD Operations)

**Use POST for state transitions:**
```
POST /orders/:id/cancel   # Cancel order
POST /orders/:id/ship     # Ship order
POST /orders/:id/confirm  # Confirm order
```

**Reasoning:** These modify state but aren't CRUD operations. They represent domain actions.

**Avoid:**
```
PATCH /orders/:id { "action": "cancel" }  # Unclear what changed
GET   /orders/:id/cancel                  # GET shouldn't have side effects
```

## Request/Response Contracts

### Request Types

**Create request (POST /resource):**
```typescript
interface CreateOrderRequest {
  customerId: string;
  items: Array<{
    productId: string;
    quantity: number;
  }>;
  shippingAddress?: {
    street: string;
    city: string;
    zipCode: string;
  };
}
```

**Update request (PATCH /resource/:id):**
```typescript
interface UpdateOrderRequest {
  status?: 'pending' | 'confirmed' | 'shipped';
  shippingAddress?: Address;
  // Only fields that can be updated
}
```

**Query parameters:**
```
GET /orders?customerId=cust-123&status=pending&limit=20&offset=0

interface ListOrdersQuery {
  customerId?: string;
  status?: OrderStatus;
  limit?: number;  // Default 20, max 100
  offset?: number; // Pagination offset
}
```

### Response Types

**Single resource (GET /resource/:id):**
```typescript
interface OrderResponse {
  id: string;
  customerId: string;
  items: OrderItem[];
  status: 'pending' | 'confirmed' | 'shipped' | 'delivered';
  total: number;
  createdAt: string;  // ISO 8601
  updatedAt: string;
}
```

**List response (GET /resource):**
```typescript
interface ListOrdersResponse {
  data: OrderResponse[];
  pagination: {
    total: number;
    limit: number;
    offset: number;
    hasMore: boolean;
  };
}
```

**Create response (POST /resource):**
```typescript
// Return created resource with 201 status
interface CreateOrderResponse extends OrderResponse {
  id: string; // Generated by server
}
```

### Timestamp Conventions

**Use ISO 8601 for all timestamps:**
```json
{
  "createdAt": "2024-01-21T10:30:45Z",
  "updatedAt": "2024-01-21T10:30:45Z",
  "deletedAt": null
}
```

**Never:** Unix timestamps, custom formats, or timezone abbreviations

## Error Handling

### HTTP Status Codes

**Success:**
- `200 OK` - GET, PATCH succeeded
- `201 Created` - POST created resource
- `204 No Content` - DELETE or update with no response body

**Client Errors:**
- `400 Bad Request` - Invalid input validation
- `401 Unauthorized` - Missing authentication
- `403 Forbidden` - Authenticated but insufficient permissions
- `404 Not Found` - Resource not found
- `409 Conflict` - State violation (can't transition state)
- `422 Unprocessable Entity` - Validation failed

**Server Errors:**
- `500 Internal Server Error` - Unhandled exception
- `503 Service Unavailable` - Temporary outage

### Error Response Format

**Validation error (400):**
```typescript
interface ValidationErrorResponse {
  error: 'Validation failed';
  code: 'VALIDATION_ERROR';
  details: {
    field: string;
    message: string;
  }[];
}

// Example
{
  "error": "Validation failed",
  "code": "VALIDATION_ERROR",
  "details": [
    { "field": "items", "message": "Must have at least one item" },
    { "field": "customerId", "message": "Invalid customer ID format" }
  ]
}
```

**Business rule violation (409):**
```typescript
interface ConflictErrorResponse {
  error: string;
  code: string;
  details?: Record<string, unknown>;
}

// Example
{
  "error": "Cannot cancel shipped order",
  "code": "ORDER_ALREADY_SHIPPED",
  "details": {
    "status": "shipped",
    "orderId": "order-123"
  }
}
```

**Not found (404):**
```json
{
  "error": "Order not found",
  "code": "ORDER_NOT_FOUND",
  "details": { "id": "order-123" }
}
```

**Generic error (500):**
```json
{
  "error": "Internal server error",
  "code": "INTERNAL_ERROR"
}
```

### Error Code Convention

Use SCREAMING_SNAKE_CASE for error codes:
- `VALIDATION_ERROR` - Input validation failed
- `ORDER_NOT_FOUND` - Resource not found
- `ORDER_ALREADY_SHIPPED` - State violation
- `INSUFFICIENT_INVENTORY` - Business rule violation
- `AUTHENTICATION_REQUIRED` - Auth failed
- `PERMISSION_DENIED` - Authz failed

## Versioning Patterns

### URL Versioning

**Include version in path:**
```
GET /v1/orders
GET /v2/orders
```

**Pros:** Explicit, clear to consumers
**Cons:** Requires multiple code paths

### Accept Header Versioning

**Use media type version:**
```
GET /orders
Accept: application/vnd.myapi.v2+json
```

**Pros:** Cleaner URLs, single endpoint
**Cons:** Less discoverable

### Pragmatic Approach

1. Start without versioning (all responses same format)
2. Add versioning when you need breaking changes
3. Support at least 2 versions during transition
4. Provide clear deprecation timeline

### Backwards Compatibility

**Adding fields (safe):**
```typescript
// v1
interface OrderResponse {
  id: string;
  total: number;
}

// v2 (backwards compatible)
interface OrderResponse {
  id: string;
  total: number;
  tax?: number;  // New optional field
}
```

**Removing fields (breaking change):**
```typescript
// Requires new API version
// v1 has 'total'
// v2 has 'subtotal' and 'tax'
```

## Example: Complete Order API

### Endpoints

```
POST /orders
  Create order
  Request: CreateOrderRequest
  Response: 201 OrderResponse

GET /orders
  List orders
  Query: ListOrdersQuery
  Response: 200 ListOrdersResponse

GET /orders/:id
  Get order
  Response: 200 OrderResponse

PATCH /orders/:id
  Update order
  Request: UpdateOrderRequest
  Response: 200 OrderResponse

POST /orders/:id/cancel
  Cancel order
  Response: 200 OrderResponse

DELETE /orders/:id
  Delete order
  Response: 204 (no body)
```

### Implementation Pattern

```typescript
// Router handles HTTP concerns
router.post('/orders', async (req, res) => {
  // 1. Parse request
  const request: CreateOrderRequest = req.body;

  // 2. Validate input (preliminary)
  if (!request.customerId) {
    return res.status(400).json({
      error: 'Validation failed',
      code: 'VALIDATION_ERROR',
      details: [{ field: 'customerId', message: 'Required' }]
    });
  }

  // 3. Call service
  const result = await orderService.createOrder(request);

  // 4. Handle result
  if (result.ok) {
    return res.status(201).json(result.value.toResponse());
  }

  // 5. Return error
  res.status(409).json({
    error: result.error,
    code: result.code || 'UNKNOWN_ERROR'
  });
});
```
